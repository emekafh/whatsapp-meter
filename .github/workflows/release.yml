name: Build & Release
on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
permissions:
  contents: write
jobs:
  build:
    strategy:
      matrix:
        include:
          - os: macos-latest
            platform: mac
          - os: windows-latest
            platform: win
          - os: ubuntu-latest
            platform: linux
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
      - run: npm ci
      - name: Bundle
        run: npx esbuild server.js --bundle --platform=node --outfile=dist/bundle.cjs --format=cjs --external:localtunnel --loader:.html=text
      - name: Generate SEA blob
        run: node --experimental-sea-config sea-config.json
      - name: Create executable (Unix)
        if: matrix.platform != 'win'
        run: |
          cp $(which node) dist/whatsapp-meter
          chmod 755 dist/whatsapp-meter
          npx postject dist/whatsapp-meter NODE_SEA_BLOB dist/sea-prep.blob --sentinel-fuse NODE_SEA_FUSE_fce680ab2cc467b6e072b8b5df1996b2
      - name: Create executable (Windows)
        if: matrix.platform == 'win'
        shell: powershell
        run: |
          Copy-Item (Get-Command node).Source dist/whatsapp-meter.exe
          npx postject dist/whatsapp-meter.exe NODE_SEA_BLOB dist/sea-prep.blob --sentinel-fuse NODE_SEA_FUSE_fce680ab2cc467b6e072b8b5df1996b2
      - name: Copy assets
        run: |
          cp node_modules/sql.js/dist/sql-wasm.wasm dist/
          cp -r public dist/
          cp .env.example dist/.env.example
        shell: bash
      - name: Package Mac .app + .dmg
        if: matrix.platform == 'mac'
        run: |
          APP="WhatsApp Meter.app"
          mkdir -p "$APP/Contents/MacOS" "$APP/Contents/Resources"
          cp dist/whatsapp-meter "$APP/Contents/MacOS/whatsapp-meter"
          cp dist/sql-wasm.wasm "$APP/Contents/MacOS/sql-wasm.wasm"
          cp -r dist/public "$APP/Contents/MacOS/public"
          cp .env.example "$APP/Contents/MacOS/.env.example"
          chmod +x "$APP/Contents/MacOS/whatsapp-meter"
          printf '#!/bin/bash\nDIR="$(cd "$(dirname "$0")" && pwd)"\ncd "$DIR"\nopen "http://localhost:3000" &\nexec ./whatsapp-meter\n' > "$APP/Contents/MacOS/WhatsApp Meter"
          chmod +x "$APP/Contents/MacOS/WhatsApp Meter"
          printf '<?xml version="1.0" encoding="UTF-8"?>\n<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">\n<plist version="1.0">\n<dict>\n<key>CFBundleName</key><string>WhatsApp Meter</string>\n<key>CFBundleIdentifier</key><string>com.emekafh.whatsapp-meter</string>\n<key>CFBundleVersion</key><string>1.0.0</string>\n<key>CFBundleExecutable</key><string>WhatsApp Meter</string>\n<key>CFBundleIconFile</key><string>AppIcon</string>\n<key>CFBundlePackageType</key><string>APPL</string>\n<key>LSMinimumSystemVersion</key><string>12.0</string>\n<key>NSHighResolutionCapable</key>\n<true/>\n</dict>\n</plist>\n' > "$APP/Contents/Info.plist"
          mkdir -p icon.iconset
          sips -z 16 16 build/icon.png --out icon.iconset/icon_16x16.png
          sips -z 32 32 build/icon.png --out icon.iconset/icon_16x16@2x.png
          sips -z 32 32 build/icon.png --out icon.iconset/icon_32x32.png
          sips -z 64 64 build/icon.png --out icon.iconset/icon_32x32@2x.png
          sips -z 128 128 build/icon.png --out icon.iconset/icon_128x128.png
          sips -z 256 256 build/icon.png --out icon.iconset/icon_128x128@2x.png
          sips -z 256 256 build/icon.png --out icon.iconset/icon_256x256.png
          sips -z 512 512 build/icon.png --out icon.iconset/icon_256x256@2x.png
          sips -z 512 512 build/icon.png --out icon.iconset/icon_512x512.png
          cp build/icon.png icon.iconset/icon_512x512@2x.png
          iconutil -c icns icon.iconset -o "$APP/Contents/Resources/AppIcon.icns"
          codesign --sign - --force --deep "$APP"
          mkdir -p dmg-stage
          cp -r "$APP" dmg-stage/
          ln -s /Applications dmg-stage/Applications
          hdiutil create -volname "WhatsApp Meter" -srcfolder dmg-stage -ov -format UDZO WhatsApp-Meter.dmg
      - name: Package Windows .zip
        if: matrix.platform == 'win'
        shell: powershell
        run: |
          New-Item -ItemType Directory -Path pkg -Force
          Copy-Item dist/whatsapp-meter.exe, dist/sql-wasm.wasm, dist/.env.example -Destination pkg/
          Copy-Item -Recurse dist/public -Destination pkg/public
          '@echo off' + "`n" + 'cd /d "%~dp0"' + "`n" + 'start http://localhost:3000' + "`n" + 'whatsapp-meter.exe' | Set-Content pkg/Start_WhatsApp_Meter.bat
          Compress-Archive -Path pkg/* -DestinationPath WhatsApp-Meter-Windows.zip
      - name: Package Linux .tar.gz
        if: matrix.platform == 'linux'
        run: |
          mkdir -p pkg
          cp dist/whatsapp-meter dist/sql-wasm.wasm dist/.env.example pkg/
          cp -r dist/public pkg/
          printf '#!/bin/bash\nDIR="$(cd "$(dirname "$0")" && pwd)"\ncd "$DIR"\nxdg-open "http://localhost:3000" 2>/dev/null &\n./whatsapp-meter\n' > pkg/start.sh
          chmod +x pkg/start.sh pkg/whatsapp-meter
          tar -czf WhatsApp-Meter-Linux.tar.gz -C pkg .
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.platform }}
          path: |
            WhatsApp-Meter.dmg
            WhatsApp-Meter-Windows.zip
            WhatsApp-Meter-Linux.tar.gz
  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: WhatsApp Meter ${{ github.ref_name }}
          body: |
            Mac: Download .dmg, open it, drag WhatsApp Meter to Applications
            Windows: Download .zip, extract, double-click Start_WhatsApp_Meter.bat
            Linux: Download .tar.gz, extract, run ./start.sh
          files: |
            artifacts/release-mac/WhatsApp-Meter.dmg
            artifacts/release-win/WhatsApp-Meter-Windows.zip
            artifacts/release-linux/WhatsApp-Meter-Linux.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
